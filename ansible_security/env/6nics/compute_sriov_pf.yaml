---
# nic1 \                 / [control address]
#       +---br_bond1 ---+
# nic2 /  (linux bridg)  \ vlan{{internal_vlanid}} [internal_address}}
#
# nic3 \                  / vlan{{storage_vlanid}} [storage_address]
#       +--- br_bond2 --->
# nic4 /  (linux bridge)  \ vlan{{storagemgmt_vlanid}} [storagemgmt_address}
#
# nic5 SRIOV PF
# nic6 SRIOV PF

network_config:
  # Config Control Network Bond
  - type: linux_bridge
    name: br_bond1
    use_dhcp: false
    mtu: {{control_mtu|int}}
    members:
      - type: linux_bond
        name: bond1
        mtu: {{control_mtu|int}}
        bonding_options: mode=1 miimon=100
        members:
          - type: interface
            name: nic1
            mtu: {{control_mtu|int}}
            primary: true
          - type: interface
            name: nic2
            mtu: {{control_mtu|int}}
    addresses:
      - ip_netmask: "{{control_address}}/{{control_prefix}}"
{% if control_gateway|bool %}
    routes:
      - ip_netmask: "0.0.0.0/0"
        next_hop: "{{ control_gateway }}"
        default: true
{% endif %}

  # Config Internal Network
  - type: vlan
    vlan_id: {{internal_vlanid |int}}
    device: br_bond1
    mtu: {{internal_mtu|int}}
    addresses:
      - ip_netmask: "{{internal_address}}/{{internal_prefix}}"

  # Config Storage Network
  - type: linux_bridge
    name: br_bond2
    use_dhcp: false
    mtu: {{storage_mtu|int}}
    members:
      - type: linux_bond
        name: bond2
        mtu: {{storage_mtu|int}}
        bonding_options: mode=1 miimon=100
        members:
          - type: interface
            name: nic3
            mtu: {{storage_mtu|int}}
            primary: true
          - type: interface
            name: nic4
            mtu: {{storage_mtu|int}}

  # Config StorageMgmt Network
  - type: vlan
    vlan_id: {{storagemgmt_vlanid|int}}
    device: br_bond2
    mtu: {{storagemgmt_mtu|int}}
    addresses:
      - ip_netmask: "{{storagemgmt_address}}/{{storagemgmt_prefix}}"

  # Config Storage Network
  - type: vlan
    vlan_id: {{storage_vlanid|int}}
    device: br_bond2
    mtu: {{storage_mtu|int}}
    addresses:
      - ip_netmask: "{{storage_address}}/{{storage_prefix}}"

  # Config Sriov Tenant Network

  - type: sriov_pf
    name: nic5
    numvfs: {{sriov_vfs}}
    use_dhcp: false
    promisc: true

  - type: sriov_pf
    name: nic6
    numvfs: {{sriov_vfs}}
    use_dhcp: false
    promisc: true
